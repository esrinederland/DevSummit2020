<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport"content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Feature Layer Item - Cascade model</title>

    <style>
        html,
        body,
        #viewDiv {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
        }
    </style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.18/esri/themes/light/main.css"
    />

    <script src="https://js.arcgis.com/4.18/"></script>

    <script>

        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/portal/PortalItem",
            // "esri/renderers/Renderer"
        ], function (Map, MapView, FeatureLayer, PortalItem/*, Renderer*/) {

            map = new Map({
                basemap: "gray"
            });

            view = new MapView({
                container: "viewDiv",
                map: map
            });

            let loadFeatureLayerItem = function(itemID, view){

                const itemsEP = 'https://www.arcgis.com/sharing/rest/content/items';
                const item = new PortalItem({
                    id: itemID,
                    portal:{
                        url: `${itemsEP}/${itemID}`
                    }
                });

                const aRender = async function (layer, data) {
                    const itemData = await getDataPromise;

                    const itemLayerData = itemData.layers[layer.id];
                    // console.log("itemLayerData=", itemLayerData)
                    properties = {
                        url: `${data.item.url}/${layer.id}`,
                        ...itemLayerData.layerDefinition,
                        popupTemplate: itemLayerData.popupInfo,
                        // visible: itemLayerData.layerDefinition.defaultVisibility,
                    };
                    // const dInfo = itemLayerData.layerDefinition.drawingInfo ?? null;
                    // if( dInfo && dInfo.renderer){
                    //     debugger
                    //     properties.renderer = new Renderer(dInfo.renderer)

                    // }
                    // console.log("properties=", properties)
                    const featureLayer = new FeatureLayer(properties);
                    map.add(featureLayer);
                };

                const renderFL = function(render, data){
                    aRender(render, data)
                }

                const getDataPromise = item.fetchData()
                    .then(data => data);
                item.load()
                    .then(function(item){

                        view.goTo(item.extent);
                        fetch(`${item.url}?f=json`)
                            .then(response =>  ({
                                    response: response.json(),
                                    item
                                }
                            ))
                            .then(data => {
                                data.response.then(serviceDefinition => {
                                    serviceDefinition.layers.forEach(layer => renderFL(layer, data));
                                })
                            });
                    });
            };

            const itemID = "195e039565ee42fbbefbcc2708bc7e26";
            console.log(`Loading Feature Layer Item Type\nDetails page: https://www.arcgis.com/home/item.html?id=${itemID}`);
            loadFeatureLayerItem(itemID, view);
        });
    </script>
</head>

<body>
    <div id="viewDiv"></div>
</body>
</html>
